<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CALLSBOTONCHAIN Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
  </head>
  <body>
    <header class="topbar">
      <div class="brand">CALLSBOTONCHAIN</div>
      <nav class="navbar horizontal">
        <a href="#" class="nav-link active" data-tab="dashboard">Dashboard</a>
        <a href="#" class="nav-link" data-tab="logs">Logs</a>
        <a href="#" class="nav-link" data-tab="tracked">Tracked</a>
      </nav>
    </header>
    <main class="content">
      <header class="content-header"><h1 class="page-title" id="page_title">Dashboard</h1></header>
      <section id="tab-dashboard" class="tab visible">
      <div class="cards">
        <div class="card">
          <div class="label">Total Alerts</div>
          <div class="value" id="total_alerts">-</div>
        </div>
        <div class="card">
          <div class="label">Cooldowns</div>
          <div class="value" id="cooldowns">-</div>
        </div>
        <div class="card">
          <div class="label">Tracking Tokens</div>
          <div class="value" id="tracking_count">-</div>
        </div>
        <div class="card">
          <div class="label">Last Cycle</div>
          <div class="value" id="last_cycle">-</div>
        </div>
        <div class="card">
          <div class="label">Signals</div>
          <div class="value"><label class="switch"><input type="checkbox" id="signals_toggle"><span class="slider"></span></label></div>
        </div>
        <div class="card">
          <div class="label">Trading</div>
          <div class="value"><label class="switch"><input type="checkbox" id="trading_toggle"><span class="slider"></span></label></div>
        </div>
        <div class="card">
          <div class="label">2x Rate</div>
          <div class="value" id="rate_2x">-</div>
        </div>
        <div class="card">
          <div class="label">5x Rate</div>
          <div class="value" id="rate_5x">-</div>
        </div>
        <div class="card">
          <div class="label">Sub‑2x Rate</div>
          <div class="value" id="rate_sub2x">-</div>
        </div>
        <div class="card">
          <div class="label">Rug Rate</div>
          <div class="value" id="rug_rate">-</div>
        </div>
        <div class="card">
          <div class="label">Median TTP (s)</div>
          <div class="value" id="median_ttp">-</div>
        </div>
        <div class="card">
          <div class="label">Realized PnL</div>
          <div class="value" id="realized_pnl">-</div>
        </div>
        <div class="card">
          <div class="label">1h Avg PnL</div>
          <div class="value" id="avg_pnl_1h">-</div>
        </div>
        <div class="card">
          <div class="label">1h Win Rate</div>
          <div class="value" id="win_rate_1h">-</div>
        </div>
      </div>

      <section>
        <h2>Recent Alerts</h2>
        <div class="sql-controls" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <input id="alerts_filter" placeholder="Filter by symbol or token" style="flex:1; max-width:320px" />
          <label class="muted"><input type="checkbox" id="alerts_only_smart" /> smart only</label>
          <label class="muted"><input type="checkbox" id="alerts_only_high" /> score ≥ 9</label>
        </div>
        <div class="table-wrap">
        <table id="alerts_table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Token</th>
              <th>Symbol</th>
              <th>Score</th>
              <th>Conviction</th>
              <th>MCap</th>
              <th>Liquidity</th>
              <th>24h Vol</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </section>

      <section>
        <h2>SQL Console</h2>
        <div class="sql-controls">
          <select id="sql_target">
            <option value="signals">Signals DB</option>
            <option value="trading">Trading DB</option>
            <option value="custom">Custom Path</option>
          </select>
          <input id="sql_path" type="text" placeholder="custom db path (when Custom selected)" style="width: 40%" />
          <label><input id="sql_write" type="checkbox" /> allow writes</label>
          <button id="sql_run">Run</button>
        </div>
        <textarea id="sql_query" rows="6" style="width:100%;margin-top:8px;" placeholder="SELECT * FROM alerted_tokens LIMIT 10;"></textarea>
        <div id="sql_status" class="muted" style="margin:8px 0 4px;"></div>
        <div id="sql_results"></div>
      </section>
      </section>

      <section id="tab-logs" class="tab">
        <h2>Logs</h2>
        <div class="sql-controls">
          <select id="logs_type">
            <option value="combined">Combined</option>
            <option value="alerts">Alerts</option>
            <option value="process">Process</option>
            <option value="tracking">Tracking</option>
          </select>
          <input id="logs_limit" type="number" value="300" min="50" step="50" style="width:120px" />
          <button id="logs_refresh">Refresh</button>
          <label style="margin-left:8px"><input id="logs_autorefresh" type="checkbox" checked /> auto</label>
        </div>
        <pre id="logs_output" style="height:420px;overflow:auto;background:#0d1117;color:#c9d1d9;padding:12px;border-radius:6px;"></pre>
      </section>

      <section id="tab-tracked" class="tab">
        <h2>Tracked Alerts</h2>
        <div class="table-wrap">
        <table id="tracked_table">
          <thead>
            <tr>
              <th>Token</th><th>Alerted</th><th>Score</th><th>Conviction</th>
              <th>Price (first → last → peak)</th>
              <th>MCap (first → last → peak)</th>
              <th>Last Liquidity</th><th>Last 24h Vol</th><th>Outcome</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </section>
      </main>

    <script>
      // ---------- Tabs ----------
      function showTab(name){
        document.querySelectorAll('.nav-link').forEach(a=>a.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(s=>s.classList.remove('visible'));
        document.querySelector(`.nav-link[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`tab-${name}`)?.classList.add('visible');
        const title = name.charAt(0).toUpperCase()+name.slice(1);
        const el = document.getElementById('page_title'); if (el) el.textContent = title;
      }
      document.querySelectorAll('.nav-link').forEach(a=>a.addEventListener('click', e=>{e.preventDefault();showTab(a.dataset.tab);}));
      showTab('dashboard');

      let sseConnected = false;
      function applyStats(data){
        const sig = data.signals_summary || {};
        document.getElementById('total_alerts').textContent = (sig.total_alerts ?? data.total_alerts) ?? '-';
        document.getElementById('cooldowns').textContent = data.cooldowns ?? '-';
        document.getElementById('tracking_count').textContent = data.tracking_count ?? '-';

        const hb = data.last_heartbeat || {};
        const cycle = hb.cycle || '-';
        const feedItems = hb.feed_items != null ? hb.feed_items : '-';
        document.getElementById('last_cycle').textContent = `${cycle} (${feedItems})`;

        const tbody = document.querySelector('#alerts_table tbody');
        const filter = (document.getElementById('alerts_filter').value||'').toLowerCase();
        const onlySmart = document.getElementById('alerts_only_smart').checked;
        const onlyHigh = document.getElementById('alerts_only_high').checked;
        tbody.innerHTML = '';
        let rows = (data.recent_alerts || []);
        rows = rows.filter(a=>{
          const sym = (a.symbol||'').toLowerCase();
          const tok = (a.token||'').toLowerCase();
          if (filter && !(sym.includes(filter) || tok.includes(filter))) return false;
          if (onlyHigh && !((a.score||0) >= 9)) return false;
          if (onlySmart && !String(a.conviction||'').toLowerCase().includes('high confidence')) return false;
          return true;
        });
        rows.forEach(a => {
          const tr = document.createElement('tr');
          const t = a.ts || '';
          tr.innerHTML = `
            <td>${t}</td>
            <td><code>${(a.token || '').slice(0,8)}...</code></td>
              <td>${a.symbol && a.symbol !== '?' ? a.symbol : (a.token ? (a.token || '').slice(0,4)+'…' : '')}</td>
            <td>${a.score != null ? a.score : ''}</td>
            <td>${a.conviction || ''}</td>
            <td>${a.market_cap != null ? ('$' + Number(a.market_cap).toLocaleString()) : ''}</td>
            <td>${a.liquidity != null ? ('$' + Number(a.liquidity).toLocaleString()) : ''}</td>
            <td>${a.vol24 != null ? ('$' + Number(a.vol24).toLocaleString()) : ''}</td>
          `;
          tbody.appendChild(tr);
        });

        const toggles = data.toggles || {};
        document.getElementById('signals_toggle').checked = !!toggles.signals_enabled;
        document.getElementById('trading_toggle').checked = !!toggles.trading_enabled;

        const sig2 = data.signals_summary || {};
        const trad = data.trading_summary || {};
        document.getElementById('rate_2x').textContent = sig2.rate_ge_2x != null ? (sig2.rate_ge_2x * 100).toFixed(1) + '%' : '-';
        document.getElementById('rate_5x').textContent = sig2.rate_ge_5x != null ? (sig2.rate_ge_5x * 100).toFixed(1) + '%' : '-';
        document.getElementById('rate_sub2x').textContent = sig2.sub_2x_rate != null ? (sig2.sub_2x_rate * 100).toFixed(1) + '%' : '-';
        document.getElementById('rug_rate').textContent = sig2.rug_rate != null ? (sig2.rug_rate * 100).toFixed(1) + '%' : '-';
        document.getElementById('median_ttp').textContent = sig2.median_ttp_price_s != null ? sig2.median_ttp_price_s : '-';
        document.getElementById('realized_pnl').textContent = trad.realized_pnl_total != null ? ('$' + Number(trad.realized_pnl_total).toLocaleString()) : '-';
        const pnl1 = sig2.avg_return_1h_pct;
        document.getElementById('avg_pnl_1h').textContent = pnl1 != null ? (pnl1 >= 0 ? '+' : '') + pnl1.toFixed(1) + '%' : '-';
        const wr1 = sig2.win_rate_1h;
        document.getElementById('win_rate_1h').textContent = wr1 != null ? (wr1 * 100).toFixed(1) + '%' : '-';
      }

      async function fetchStats() {
        try {
          const r = await fetch('/api/stats');
          const data = await r.json();
          applyStats(data);
        } catch (e) {
          console.error('Failed to fetch stats', e);
        }
      }
      try {
        const evt = new EventSource('/api/stream');
        evt.onmessage = (ev)=>{
          sseConnected = true;
          try { const data = JSON.parse(ev.data||'{}'); applyStats(data); } catch(e){}
        };
        evt.onerror = ()=>{ sseConnected = false; };
      } catch (e) { /* ignore */ }
      fetchStats();
      setInterval(()=>{ if (!sseConnected) fetchStats(); }, 5000);

      async function postToggles() {
        const signals_enabled = document.getElementById('signals_toggle').checked;
        const trading_enabled = document.getElementById('trading_toggle').checked;
        try {
          await fetch('/api/toggles', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ signals_enabled, trading_enabled }) });
        } catch (e) {
          console.error('Failed to update toggles', e);
        }
      }
      document.getElementById('signals_toggle').addEventListener('change', postToggles);
      document.getElementById('trading_toggle').addEventListener('change', postToggles);

      function renderTable(columns, rows) {
        const el = document.createElement('table');
        el.innerHTML = `
          <thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>
          <tbody>
            ${rows.map(r => `<tr>${columns.map(c => `<td>${r[c] != null ? r[c] : ''}</td>`).join('')}</tr>`).join('')}
          </tbody>
        `;
        return el;
      }

      async function runSQL() {
        const target = document.getElementById('sql_target').value;
        const path = document.getElementById('sql_path').value.trim();
        const allow_writes = document.getElementById('sql_write').checked;
        const query = document.getElementById('sql_query').value;
        const status = document.getElementById('sql_status');
        const results = document.getElementById('sql_results');
        status.textContent = 'Running...';
        results.innerHTML = '';
        try {
          const r = await fetch('/api/sql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ target, path, allow_writes, query }) });
          const data = await r.json();
          if (!data.ok) {
            status.textContent = `Error: ${data.error || 'unknown'}`;
            return;
          }
          status.textContent = `OK • rows: ${data.rows.length} • db: ${data.db}`;
          const table = renderTable(data.columns || [], data.rows || []);
          results.appendChild(table);
        } catch (e) {
          status.textContent = 'Request failed';
        }
      }
      document.getElementById('sql_run').addEventListener('click', runSQL);
      document.getElementById('alerts_filter').addEventListener('input', fetchStats);
      document.getElementById('alerts_only_smart').addEventListener('change', fetchStats);
      document.getElementById('alerts_only_high').addEventListener('change', fetchStats);

      // ---------- Logs ----------
      let logsTimer = null;
      async function fetchLogs(){
        const type = document.getElementById('logs_type').value;
        const limit = parseInt(document.getElementById('logs_limit').value||300,10);
        try{
          const r = await fetch(`/api/logs?type=${encodeURIComponent(type)}&limit=${limit}`);
          const data = await r.json();
          const pretty = (o)=>{ try{ return JSON.stringify(o, null, 2); }catch(e){ return String(o); } };
          const out = (data.rows||[]).map(pretty).join('\n\n');
          const pre = document.getElementById('logs_output');
          const atBottom = pre.scrollTop + pre.clientHeight >= pre.scrollHeight - 5;
          pre.textContent = out;
          if(atBottom) pre.scrollTop = pre.scrollHeight;
        }catch(e){/* ignore */}
      }
      function startLogsAuto(){
        if (logsTimer) clearInterval(logsTimer);
        if (document.getElementById('logs_autorefresh').checked){
          logsTimer = setInterval(fetchLogs, 3000);
        }
      }
      document.getElementById('logs_refresh').addEventListener('click', fetchLogs);
      document.getElementById('logs_autorefresh').addEventListener('change', startLogsAuto);
      // optional wrap/copy controls if present
      const wrapEl = document.getElementById('logs_wrap');
      if (wrapEl) wrapEl.addEventListener('change', ()=>{
        const pre = document.getElementById('logs_output');
        if (wrapEl.checked){ pre.style.whiteSpace='pre-wrap'; pre.style.wordBreak='break-word'; }
        else { pre.style.whiteSpace='pre'; pre.style.wordBreak='normal'; }
      });
      const copyEl = document.getElementById('logs_copy');
      if (copyEl) copyEl.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(document.getElementById('logs_output').textContent||''); }catch(e){}
      });
      fetchLogs(); startLogsAuto();

      // ---------- Tracked ----------
      async function fetchTracked(){
        try{
          const r = await fetch('/api/tracked?limit=200');
          const data = await r.json();
          const tbody = document.querySelector('#tracked_table tbody');
          tbody.innerHTML = '';
          (data.rows||[]).forEach(row=>{
            const tr = document.createElement('tr');
            const fmt = (v, d=8)=> (v!=null && v!==0 ? Number(v).toFixed(d) : '-')
            const fmtMoney = (v)=> (v!=null && v!==0 ? ('$'+Number(v).toLocaleString()) : '-')
            tr.innerHTML = `
              <td><code>${(row.token||'').slice(0,8)}...</code></td>
              <td>${row.alerted_at||'-'}</td>
              <td>${row.final_score??'-'}</td>
              <td>${row.conviction||'-'}</td>
              <td>${[fmt(row.first_price),fmt(row.last_price),fmt(row.peak_price)].join(' → ')}</td>
              <td>${[fmtMoney(row.first_mcap),fmtMoney(row.last_mcap),fmtMoney(row.peak_mcap)].join(' → ')}</td>
              <td>${fmtMoney(row.last_liq)}</td>
              <td>${fmtMoney(row.last_vol24)}</td>
              <td>${row.outcome||'-'}${row.peak_drawdown_pct!=null?(' ('+Number(row.peak_drawdown_pct).toFixed(1)+'%)'):''}</td>
            `;
            tbody.appendChild(tr);
          })
        }catch(e){/* ignore */}
      }
      fetchTracked(); setInterval(fetchTracked, 15000);
    </script>
  </body>
  </html>


