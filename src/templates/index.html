<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CALLSBOTONCHAIN Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css?v=3">
  </head>
  <body>
    <div id="statusbar" style="font-family:monospace;font-size:12px;padding:6px 8px;background:#111;color:#eee;display:flex;gap:16px;align-items:center">
      <span>Signals: <b id="status_signals">?</b></span>
      <span>Trading: <b id="status_trading">?</b></span>
      <span>Kill Switch: <b id="status_kill">?</b></span>
      <span>Cache Hit%: <b id="status_cache">?</b></span>
      <span>API Errors%: <b id="status_api_err">?</b></span>
      <span>Last: <b id="status_last">-</b></span>
    </div>
    <header class="topbar">
      <div class="brand">CALLSBOTONCHAIN</div>
      <nav class="navbar horizontal">
        <a href="#" class="nav-link active" data-tab="overview">Overview</a>
        <a href="#" class="nav-link" data-tab="performance">Performance</a>
        <a href="#" class="nav-link" data-tab="system">System</a>
        <a href="#" class="nav-link" data-tab="config">Config</a>
        <a href="#" class="nav-link" data-tab="paper">Paper</a>
        <a href="#" class="nav-link" data-tab="logs">Logs</a>
        <a href="#" class="nav-link" data-tab="tracked">Tracked</a>
      </nav>
    </header>
    <main class="content">
      <header class="content-header"><h1 class="page-title" id="page_title">Dashboard</h1></header>
      <section id="tab-overview" class="tab visible">
      <div class="cards">
        <div class="card">
          <div class="label">Total Alerts</div>
          <div class="value" id="total_alerts">-</div>
        </div>
        <div class="card">
          <div class="label">Alerts 24h</div>
          <div class="value" id="alerts_24h">-</div>
        </div>
        <div class="card">
          <div class="label">Cooldowns</div>
          <div class="value" id="cooldowns">-</div>
        </div>
        <div class="card">
          <div class="label">Tracking Tokens</div>
          <div class="value" id="tracking_count">-</div>
        </div>
        <div class="card">
          <div class="label">Last Cycle</div>
          <div class="value" id="last_cycle">-</div>
        </div>
        <div class="card">
          <div class="label">Signals</div>
          <div class="value"><label class="switch"><input type="checkbox" id="signals_toggle"><span class="slider"></span></label></div>
        </div>
        <div class="card">
          <div class="label">Trading</div>
          <div class="value"><label class="switch"><input type="checkbox" id="trading_toggle"><span class="slider"></span></label></div>
        </div>
        <div class="card">
          <div class="label">2x Rate</div>
          <div class="value" id="rate_2x">-</div>
        </div>
        <div class="card">
          <div class="label">5x Rate</div>
          <div class="value" id="rate_5x">-</div>
        </div>
        <div class="card">
          <div class="label">Sub‑2x Rate</div>
          <div class="value" id="rate_sub2x">-</div>
        </div>
        <div class="card">
          <div class="label">Rug Rate</div>
          <div class="value" id="rug_rate">-</div>
        </div>
        <div class="card">
          <div class="label">Median TTP (s)</div>
          <div class="value" id="median_ttp">-</div>
        </div>
        <div class="card">
          <div class="label">Realized PnL</div>
          <div class="value" id="realized_pnl">-</div>
        </div>
        <div class="card">
          <div class="label">1h Avg PnL</div>
          <div class="value" id="avg_pnl_1h">-</div>
        </div>
        <div class="card">
          <div class="label">1h Win Rate</div>
          <div class="value" id="win_rate_1h">-</div>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <div class="label">Smart Money (24h)</div>
          <div class="value" id="sm_24h">-</div>
          <div class="muted" id="sm_status" style="margin-top:4px"></div>
        </div>
        <div class="card">
          <div class="label">Feed Health</div>
          <div class="value" id="feed_status">-</div>
          <div class="muted" id="feed_cycle" style="margin-top:4px"></div>
        </div>
        <div class="card">
          <div class="label">API Budget (Day)</div>
          <div class="value" id="budget_day">-</div>
          <div class="muted" id="budget_reset" style="margin-top:4px"></div>
        </div>
      </div>

      <section>
        <h2>Recent Alerts</h2>
        <div class="sql-controls" style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <input id="alerts_filter" placeholder="Filter by symbol or token" style="flex:1; max-width:320px" />
          <label class="muted"><input type="checkbox" id="alerts_only_smart" /> smart only</label>
          <label class="muted"><input type="checkbox" id="alerts_only_high" /> score ≥ 9</label>
        </div>
        <div class="table-wrap">
        <table id="alerts_table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Token</th>
              <th>Symbol</th>
              <th>Score</th>
              <th>Conviction</th>
              <th>MCap</th>
              <th>Liquidity</th>
              <th>24h Vol</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </section>

      <section>
        <h2>SQL Console</h2>
        <div class="sql-controls">
          <select id="sql_target">
            <option value="signals">Signals DB</option>
            <option value="trading">Trading DB</option>
            <option value="custom">Custom Path</option>
          </select>
          <input id="sql_path" type="text" placeholder="custom db path (when Custom selected)" style="width: 40%" />
          <label><input id="sql_write" type="checkbox" /> allow writes</label>
          <button id="sql_run">Run</button>
        </div>
        <textarea id="sql_query" rows="6" style="width:100%;margin-top:8px;" placeholder="SELECT * FROM alerted_tokens LIMIT 10;"></textarea>
        <div id="sql_status" class="muted" style="margin:8px 0 4px;"></div>
        <div id="sql_results"></div>
      </section>
      </section>

      <section id="tab-performance" class="tab">
        <h2>Signal Quality</h2>
        <div class="cards">
          <div class="card"><div class="label">Avg Score</div><div class="value" id="perf_avg_score">-</div></div>
          <div class="card"><div class="label">Total Signals (24h)</div><div class="value" id="perf_total">-</div></div>
        </div>
        <div class="table-wrap" style="margin-top:8px">
          <table id="conviction_table"><thead><tr><th>Conviction</th><th>Count</th></tr></thead><tbody></tbody></table>
        </div>
        <h2 style="margin-top:16px">Score Distribution</h2>
        <div class="table-wrap"><table id="score_table"><thead><tr><th>Range</th><th>Count</th></tr></thead><tbody></tbody></table></div>
        <h2 style="margin-top:16px">Trends (7 days)</h2>
        <div class="table-wrap"><table id="trends_table"><thead><tr><th>Date</th><th>Alerts</th><th>Smart %</th><th>Avg Score</th></tr></thead><tbody></tbody></table></div>
        <h2 style="margin-top:16px">Hourly Heatmap (24h)</h2>
        <div class="table-wrap"><table id="heatmap_table"><thead><tr><th>Hour</th><th>Alerts</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="tab-system" class="tab">
        <h2>System Health</h2>
        <div class="cards">
          <div class="card"><div class="label">CPU</div><div class="value" id="sys_cpu">-</div></div>
          <div class="card"><div class="label">Memory</div><div class="value" id="sys_mem">-</div></div>
          <div class="card"><div class="label">Disk</div><div class="value" id="sys_disk">-</div></div>
        </div>
        <h3>Containers</h3>
        <div class="table-wrap"><table id="containers_table"><thead><tr><th>Name</th><th>Status</th></tr></thead><tbody></tbody></table></div>
        <h3 style="margin-top:16px">Database</h3>
        <div class="table-wrap"><table id="db_table"><thead><tr><th>Table</th><th>Rows</th></tr></thead><tbody></tbody></table></div>
        <h3 style="margin-top:16px">Errors & Warnings</h3>
        <div class="table-wrap"><table id="errors_table"><thead><tr><th>Time</th><th>Level</th><th>Type</th><th>Component</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="tab-config" class="tab">
        <h2>Configuration</h2>
        <div class="cards">
          <div class="card"><div class="label">Signals</div><div class="value"><label class="switch"><input type="checkbox" id="cfg_signals"><span class="slider"></span></label></div></div>
          <div class="card"><div class="label">Trading</div><div class="value"><label class="switch"><input type="checkbox" id="cfg_trading"><span class="slider"></span></label></div></div>
        </div>
        <div class="table-wrap" style="margin-top:8px"><table id="cfg_table"><thead><tr><th>Group</th><th>Key</th><th>Value</th></tr></thead><tbody></tbody></table></div>
      </section>

      <section id="tab-paper" class="tab">
        <h2>Paper Trading</h2>
        <div class="cards">
          <div class="card">
            <div class="label">Starting Capital</div>
            <div class="value"><input id="pt_capital" type="number" value="1000" min="100" step="50" style="width:140px"></div>
          </div>
          <div class="card">
            <div class="label">Strategy</div>
            <div class="value">
              <select id="pt_strategy">
                <option value="smart_money_only">Smart Money Only</option>
                <option value="high_conviction">High Conviction (≥7)</option>
                <option value="all_signals">All Signals</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="label">Position Sizing</div>
            <div class="value">
              <select id="pt_sizing">
                <option value="fixed_50">Fixed $50</option>
                <option value="percentage_5">5% Capital</option>
                <option value="score_based">Score-Based</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="label">Max Concurrent</div>
            <div class="value"><input id="pt_max" type="number" value="5" min="1" max="20" style="width:100px"></div>
          </div>
        </div>
        <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap">
          <button id="pt_start">Start Session</button>
          <button id="pt_stop">Stop</button>
          <button id="pt_reset">Reset</button>
        </div>
        <h3>Portfolio</h3>
        <div id="pt_portfolio" class="table-wrap"></div>
        <h3 style="margin-top:16px">Backtest</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <label>Days <input id="bt_days" type="number" value="7" min="1" max="60" style="width:100px"></label>
          <label>Capital $ <input id="bt_capital" type="number" value="1000" min="100" step="50" style="width:120px"></label>
          <select id="bt_strategy">
            <option value="smart_money_only">Smart Money Only</option>
            <option value="high_conviction">High Conviction (≥7)</option>
            <option value="all_signals">All Signals</option>
          </select>
          <button id="bt_run">Run Backtest</button>
        </div>
        <pre id="bt_output" style="height:200px;overflow:auto;background:#0d1117;color:#c9d1d9;padding:12px;border-radius:6px;margin-top:8px"></pre>
      </section>

      <section id="tab-logs" class="tab">
        <h2>Logs</h2>
        <div class="sql-controls">
          <select id="logs_type">
            <option value="combined">Combined</option>
            <option value="alerts">Alerts</option>
            <option value="process">Process</option>
            <option value="tracking">Tracking</option>
          </select>
          <input id="logs_limit" type="number" value="300" min="50" step="50" style="width:120px" />
          <button id="logs_refresh">Refresh</button>
          <label style="margin-left:8px"><input id="logs_autorefresh" type="checkbox" checked /> auto</label>
        </div>
        <pre id="logs_output" style="height:420px;overflow:auto;background:#0d1117;color:#c9d1d9;padding:12px;border-radius:6px;"></pre>
      </section>

      <section id="tab-tracked" class="tab">
        <h2>Tracked Alerts</h2>
        <div class="table-wrap">
        <table id="tracked_table">
          <thead>
            <tr>
              <th>Token</th><th>Alerted</th><th>Score</th><th>Conviction</th>
              <th>Price (first → last → peak)</th>
              <th>Peak Multiple</th>
              <th>MCap (first → last → peak)</th>
              <th>Last Liquidity</th><th>Last 24h Vol</th><th>Outcome</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </section>
      </main>

    <script>
      // ---------- Tabs ----------
      function showTab(name){
        document.querySelectorAll('.nav-link').forEach(a=>a.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(s=>s.classList.remove('visible'));
        document.querySelector(`.nav-link[data-tab="${name}"]`)?.classList.add('active');
        document.getElementById(`tab-${name}`)?.classList.add('visible');
        const title = name.charAt(0).toUpperCase()+name.slice(1);
        const el = document.getElementById('page_title'); if (el) el.textContent = title;
        if (name === 'tracked') { try { fetchTracked(); } catch (e) {} }
        if (name === 'overview') { try { fetchOverviewV2(); } catch (e) {} }
        if (name === 'performance') { try { fetchPerformanceV2(); } catch (e) {} }
        if (name === 'system') { try { fetchSystemV2(); } catch (e) {} }
        if (name === 'config') { try { fetchConfigV2(); } catch (e) {} }
        if (name === 'logs') { try { fetchLogs(); } catch (e) {} }
        if (name === 'paper') { 
          try { fetchPaperV2(); } catch (e) {} 
          startPaperAutoRefresh(); // Start auto-refresh for paper trading
        } else {
          stopPaperAutoRefresh(); // Stop auto-refresh when leaving paper tab
        }
      }
      document.querySelectorAll('.nav-link').forEach(a=>a.addEventListener('click', e=>{e.preventDefault();showTab(a.dataset.tab);}));
      // Prime both data sources on load to avoid initial empties
      setTimeout(()=>{ try{ fetchStats(); }catch(e){} try{ fetchTracked(); }catch(e){} }, 100);
      showTab('overview');

      let sseConnected = false;
      async function resolveAxiomUrl(token){
        const t = token || '';
        try{
          const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${encodeURIComponent(t)}`);
          const j = await r.json();
          const pair = (j.pairs||[]).find(p=>p.chainId==='solana') || (j.pairs||[])[0];
          if (pair && pair.pairAddress){
            return `https://axiom.trade/meme/${encodeURIComponent(pair.pairAddress)}`;
          }
        }catch(e){/* ignore and fallback */}
        return `https://axiom.trade/?search=${encodeURIComponent(t)}`;
      }
      function onAxiomClick(ev){
        ev.preventDefault();
        const a = ev.currentTarget;
        const tok = a?.dataset?.token || '';
        resolveAxiomUrl(tok).then(url=>{ try{ window.open(url, '_blank', 'noopener'); }catch(e){ location.href = url; }});
      }
      function tokenLinks(addr){
        const t = addr || '';
        if (!t || t.length < 20) {
          // If token is missing or too short, show clear error
          return `<span style="color:#ff6b6b;">INVALID</span>`;
        }
        const short = t.slice(0,8) + '...' + t.slice(-4);
        // Render clickable CA that resolves to the correct Axiom link at click time
        return `<a href="https://axiom.trade/?search=${encodeURIComponent(t)}" data-token="${encodeURIComponent(t)}" onclick="onAxiomClick(event)" rel="noopener noreferrer" title="${t}"><code>${short}</code></a>`;
      }
      function applyStats(data){
        const sig = data.signals_summary || {};
        const totalAlertsVal = (sig.total_alerts ?? data.total_alerts ?? data.log_alerts_count ?? 0);
        document.getElementById('total_alerts').textContent = String(totalAlertsVal);
        if (sig.alerts_24h != null) {
          document.getElementById('alerts_24h').textContent = sig.alerts_24h;
        }
        document.getElementById('cooldowns').textContent = (data.cooldowns != null) ? String(data.cooldowns) : '0';
        document.getElementById('tracking_count').textContent = (data.tracking_count != null) ? String(data.tracking_count) : '0';

        const hb = data.last_heartbeat || {};
        const cycle = hb.cycle || '-';
        const feedItems = hb.feed_items != null ? hb.feed_items : '-';
        document.getElementById('last_cycle').textContent = `${cycle} (${feedItems})`;

        const tbody = document.querySelector('#alerts_table tbody');
        const filter = (document.getElementById('alerts_filter').value||'').toLowerCase();
        const onlySmart = document.getElementById('alerts_only_smart').checked;
        const onlyHigh = document.getElementById('alerts_only_high').checked;
        tbody.innerHTML = '';
        let rows = (data.recent_alerts || []);
        rows = rows.filter(a=>{
          const sym = (a.symbol||'').toLowerCase();
          const tok = (a.token||'').toLowerCase();
          if (filter && !(sym.includes(filter) || tok.includes(filter))) return false;
          if (onlyHigh && !((a.score||0) >= 9)) return false;
          if (onlySmart && !String(a.conviction||'').toLowerCase().includes('high confidence')) return false;
          return true;
        });
        rows.forEach(a => {
          const tr = document.createElement('tr');
          const t = a.ts || '';
          tr.innerHTML = `
            <td>${t}</td>
            <td>${tokenLinks(a.token)}</td>
              <td>${a.symbol && a.symbol !== '?' ? a.symbol : (a.token ? (a.token || '').slice(0,4)+'…' : '')}</td>
            <td>${a.score != null ? a.score : ''}</td>
            <td>${a.conviction || ''}</td>
            <td>${a.market_cap != null ? ('$' + Number(a.market_cap).toLocaleString()) : ''}</td>
            <td>${a.liquidity != null ? ('$' + Number(a.liquidity).toLocaleString()) : ''}</td>
            <td>${a.vol24 != null ? ('$' + Number(a.vol24).toLocaleString()) : ''}</td>
          `;
          tbody.appendChild(tr);
        });

        const toggles = data.toggles || {};
        document.getElementById('signals_toggle').checked = !!toggles.signals_enabled;
        document.getElementById('trading_toggle').checked = !!toggles.trading_enabled;

        const sig2 = data.signals_summary || {};
        const trad = data.trading_summary || {};
        document.getElementById('rate_2x').textContent = sig2.rate_ge_2x != null ? (sig2.rate_ge_2x * 100).toFixed(1) + '%' : '-';
        document.getElementById('rate_5x').textContent = sig2.rate_ge_5x != null ? (sig2.rate_ge_5x * 100).toFixed(1) + '%' : '-';
        document.getElementById('rate_sub2x').textContent = sig2.sub_2x_rate != null ? (sig2.sub_2x_rate * 100).toFixed(1) + '%' : '-';
        document.getElementById('rug_rate').textContent = sig2.rug_rate != null ? (sig2.rug_rate * 100).toFixed(1) + '%' : '-';
        document.getElementById('median_ttp').textContent = sig2.median_ttp_price_s != null ? sig2.median_ttp_price_s : '-';
        document.getElementById('realized_pnl').textContent = trad.realized_pnl_total != null ? ('$' + Number(trad.realized_pnl_total).toLocaleString()) : '-';
        const pnl1 = sig2.avg_return_1h_pct;
        document.getElementById('avg_pnl_1h').textContent = pnl1 != null ? (pnl1 >= 0 ? '+' : '') + pnl1.toFixed(1) + '%' : '-';
        const wr1 = sig2.win_rate_1h;
        document.getElementById('win_rate_1h').textContent = wr1 != null ? (wr1 * 100).toFixed(1) + '%' : '-';
      }

      async function fetchStats() {
        try {
          const r = await fetch('/api/stats');
          const data = await r.json();
          applyStats(data);
          // Update simple status indicators
          try {
            document.getElementById('status_signals').textContent = String((data.toggles||{}).signals_enabled);
            document.getElementById('status_trading').textContent = String((data.toggles||{}).trading_enabled);
            document.getElementById('status_kill').textContent = String(!!data.kill_switch);
            const m = (data.metrics||{});
            const apiErr = (m.api_error_pct!=null)? (m.api_error_pct.toFixed? m.api_error_pct.toFixed(1): m.api_error_pct): null;
            document.getElementById('status_api_err').textContent = apiErr!=null ? String(apiErr)+'%' : '-';
            document.getElementById('status_cache').textContent = (m.cache_hit_pct!=null) ? String(m.cache_hit_pct)+'%' : '-';
            document.getElementById('status_last').textContent = new Date().toLocaleTimeString();
          } catch (e) {}
        } catch (e) {
          console.error('Failed to fetch stats', e);
        }
      }
      try {
        const evt = new EventSource('/api/stream');
        evt.onmessage = (ev)=>{
          sseConnected = true;
          try { const data = JSON.parse(ev.data||'{}'); applyStats(data); } catch(e){}
        };
        evt.onerror = ()=>{ sseConnected = false; };
      } catch (e) { /* ignore */ }
      fetchStats();
      // Poll every 5 seconds (or faster if SSE is not connected)
      setInterval(()=>{ fetchStats(); }, 5000);
      
      // Auto-refresh active tab every 10 seconds
      setInterval(()=>{
        const activeTab = document.querySelector('.nav-link.active')?.dataset?.tab;
        if (activeTab === 'overview') { try { fetchOverviewV2(); } catch (e) {} }
        if (activeTab === 'performance') { try { fetchPerformanceV2(); } catch (e) {} }
        if (activeTab === 'system') { try { fetchSystemV2(); } catch (e) {} }
        if (activeTab === 'config') { try { fetchConfigV2(); } catch (e) {} }
        if (activeTab === 'tracked') { try { fetchTracked(); } catch (e) {} }
      }, 10000);

      // Enhanced toggle functionality with v2 API and visual feedback
      async function updateToggle(toggleName, value) {
        try {
          const response = await fetch('/api/v2/update-toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: toggleName, value: value })
          });
          const result = await response.json();
          
          if (result.success) {
            showNotification(`✅ ${toggleName} ${value ? 'enabled' : 'disabled'}`, 'success');
          } else {
            showNotification(`❌ Failed to update ${toggleName}: ${result.error}`, 'error');
            // Revert the toggle
            const checkbox = document.getElementById(toggleName + '_toggle');
            if (checkbox) checkbox.checked = !value;
          }
        } catch (e) {
          console.error('Failed to update toggle', e);
          showNotification(`❌ Error updating ${toggleName}`, 'error');
          // Revert the toggle
          const checkbox = document.getElementById(toggleName + '_toggle');
          if (checkbox) checkbox.checked = !value;
        }
      }

      function showNotification(message, type = 'info') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        notif.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          background: ${type === 'success' ? '#17bf63' : type === 'error' ? '#e0245e' : '#1da1f2'};
          color: white;
          border-radius: 8px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(notif);
        
        setTimeout(() => {
          notif.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notif.remove(), 300);
        }, 3000);
      }

      // Add animation styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);

      // Wire up toggle switches
      document.getElementById('signals_toggle').addEventListener('change', function() {
        updateToggle('signals_enabled', this.checked);
      });
      document.getElementById('trading_toggle').addEventListener('change', function() {
        if (this.checked && !confirm('⚠️ Enable LIVE TRADING? This will execute real trades with real money!')) {
          this.checked = false;
          return;
        }
        updateToggle('trading_enabled', this.checked);
      });

      // Paper Trading Controls
      async function startPaperTrading() {
        const capital = parseFloat(document.getElementById('pt_capital').value) || 1000;
        const strategy = document.getElementById('pt_strategy').value;
        const sizing = document.getElementById('pt_sizing').value;
        const max_concurrent = parseInt(document.getElementById('pt_max').value) || 5;

        try {
          const response = await fetch('/api/v2/paper/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ capital, strategy, position_sizing: sizing, max_concurrent })
          });
          const result = await response.json();
          
          if (result.success) {
            showNotification('📊 Paper trading session started!', 'success');
            refreshPaperPortfolio();
          } else {
            showNotification(`❌ Failed to start: ${result.error}`, 'error');
          }
        } catch (e) {
          console.error('Failed to start paper trading', e);
          showNotification('❌ Error starting paper trading', 'error');
        }
      }

      async function stopPaperTrading() {
        if (!confirm('⏸️ Stop the current paper trading session?')) return;
        
        try {
          const response = await fetch('/api/v2/paper/stop', { method: 'POST' });
          const result = await response.json();
          
          if (result.success) {
            showNotification('⏸️ Paper trading stopped', 'success');
            refreshPaperPortfolio();
          } else {
            showNotification(`❌ Failed to stop: ${result.error}`, 'error');
          }
        } catch (e) {
          console.error('Failed to stop paper trading', e);
          showNotification('❌ Error stopping paper trading', 'error');
        }
      }

      async function resetPaperTrading() {
        if (!confirm('🔄 Reset paper trading? This will clear all positions and history!')) return;
        
        try {
          const response = await fetch('/api/v2/paper/reset', { method: 'POST' });
          const result = await response.json();
          
          if (result.success) {
            showNotification('🔄 Paper trading reset', 'success');
            refreshPaperPortfolio();
          } else {
            showNotification(`❌ Failed to reset: ${result.error}`, 'error');
          }
        } catch (e) {
          console.error('Failed to reset paper trading', e);
          showNotification('❌ Error resetting paper trading', 'error');
        }
      }

      async function refreshPaperPortfolio() {
        try {
          const response = await fetch('/api/v2/paper/portfolio');
          const portfolio = await response.json();
          
          const container = document.getElementById('pt_portfolio');
          if (!portfolio || portfolio.error) {
            container.innerHTML = '<div class="card"><div class="value" style="text-align:center;padding:20px;color:#8899a6">No active session</div></div>';
            return;
          }

          let html = '<div class="cards">';
          html += `<div class="card"><div class="label">Starting Capital</div><div class="value">$${portfolio.starting_capital?.toFixed(2) || '0.00'}</div></div>`;
          html += `<div class="card"><div class="label">Current Value</div><div class="value">$${portfolio.current_value?.toFixed(2) || '0.00'}</div></div>`;
          
          const pnl = portfolio.total_pnl || 0;
          const pnlPct = portfolio.total_pnl_pct || 0;
          const pnlColor = pnl >= 0 ? '#17bf63' : '#e0245e';
          html += `<div class="card"><div class="label">Total P/L</div><div class="value" style="color:${pnlColor}">$${pnl.toFixed(2)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)</div></div>`;
          
          html += `<div class="card"><div class="label">Open Positions</div><div class="value">${portfolio.open_positions || 0}</div></div>`;
          html += `<div class="card"><div class="label">Total Trades</div><div class="value">${portfolio.total_trades || 0}</div></div>`;
          html += `<div class="card"><div class="label">Win Rate</div><div class="value">${portfolio.win_rate?.toFixed(1) || '0.0'}%</div></div>`;
          html += '</div>';

          if (portfolio.positions && portfolio.positions.length > 0) {
            html += '<h4 style="margin-top:16px">Open Positions</h4>';
            html += '<table style="width:100%;margin-top:8px"><thead><tr><th>Token</th><th>Entry</th><th>Current</th><th>P/L</th><th>Size</th></tr></thead><tbody>';
            portfolio.positions.forEach(pos => {
              const posColor = (pos.pnl_pct || 0) >= 0 ? '#17bf63' : '#e0245e';
              html += `<tr>
                <td>${pos.token_short || pos.token || 'N/A'}</td>
                <td>$${pos.entry_price?.toFixed(6) || '0'}</td>
                <td>$${pos.current_price?.toFixed(6) || '0'}</td>
                <td style="color:${posColor}">${(pos.pnl_pct || 0) >= 0 ? '+' : ''}${pos.pnl_pct?.toFixed(2) || '0'}%</td>
                <td>$${pos.size_usd?.toFixed(2) || '0'}</td>
              </tr>`;
            });
            html += '</tbody></table>';
          }

          container.innerHTML = html;
        } catch (e) {
          console.error('Failed to refresh portfolio', e);
          document.getElementById('pt_portfolio').innerHTML = '<div class="card"><div class="value" style="color:#e0245e">Error loading portfolio</div></div>';
        }
      }

      async function runBacktest() {
        const days = parseInt(document.getElementById('bt_days').value) || 7;
        const capital = parseFloat(document.getElementById('bt_capital').value) || 1000;
        const strategy = document.getElementById('bt_strategy').value;

        const output = document.getElementById('bt_output');
        output.textContent = 'Running backtest...\n';

        try {
          const response = await fetch('/api/v2/paper/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days, capital, strategy })
          });
          const result = await response.json();
          
          if (result.success && result.results) {
            const r = result.results;
            let text = `Backtest Results (${days} days, $${capital} capital, ${strategy})\n`;
            text += `${'='.repeat(60)}\n\n`;
            text += `Total Trades: ${r.total_trades || 0}\n`;
            text += `Win Rate: ${r.win_rate?.toFixed(1) || '0.0'}%\n`;
            text += `Final Value: $${r.final_value?.toFixed(2) || '0.00'}\n`;
            text += `Total P/L: $${r.total_pnl?.toFixed(2) || '0.00'} (${r.total_pnl_pct >= 0 ? '+' : ''}${r.total_pnl_pct?.toFixed(2) || '0'}%)\n`;
            text += `Max Drawdown: ${r.max_drawdown?.toFixed(2) || '0'}%\n`;
            text += `Sharpe Ratio: ${r.sharpe_ratio?.toFixed(2) || 'N/A'}\n`;
            output.textContent = text;
            showNotification('✅ Backtest complete!', 'success');
          } else {
            output.textContent = `Error: ${result.error || 'Unknown error'}`;
            showNotification(`❌ Backtest failed: ${result.error}`, 'error');
          }
        } catch (e) {
          console.error('Failed to run backtest', e);
          output.textContent = `Error: ${e.message}`;
          showNotification('❌ Error running backtest', 'error');
        }
      }

      // Wire up paper trading buttons
      document.getElementById('pt_start').addEventListener('click', startPaperTrading);
      document.getElementById('pt_stop').addEventListener('click', stopPaperTrading);
      document.getElementById('pt_reset').addEventListener('click', resetPaperTrading);
      document.getElementById('bt_run').addEventListener('click', runBacktest);

      // Auto-refresh paper portfolio when tab is active
      let paperRefreshInterval;
      function startPaperAutoRefresh() {
        if (paperRefreshInterval) clearInterval(paperRefreshInterval);
        refreshPaperPortfolio(); // Initial load
        paperRefreshInterval = setInterval(refreshPaperPortfolio, 10000); // Refresh every 10s
      }
      function stopPaperAutoRefresh() {
        if (paperRefreshInterval) {
          clearInterval(paperRefreshInterval);
          paperRefreshInterval = null;
        }
      }

      function renderTable(columns, rows) {
        const el = document.createElement('table');
        el.innerHTML = `
          <thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>
          <tbody>
            ${rows.map(r => `<tr>${columns.map(c => `<td>${r[c] != null ? r[c] : ''}</td>`).join('')}</tr>`).join('')}
          </tbody>
        `;
        return el;
      }

      async function runSQL() {
        const target = document.getElementById('sql_target').value;
        const path = document.getElementById('sql_path').value.trim();
        const allow_writes = document.getElementById('sql_write').checked;
        const query = document.getElementById('sql_query').value;
        const status = document.getElementById('sql_status');
        const results = document.getElementById('sql_results');
        status.textContent = 'Running...';
        results.innerHTML = '';
        try {
          const r = await fetch('/api/sql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ target, path, allow_writes, query }) });
          const data = await r.json();
          if (!data.ok) {
            status.textContent = `Error: ${data.error || 'unknown'}`;
            return;
          }
          status.textContent = `OK • rows: ${data.rows.length} • db: ${data.db}`;
          const table = renderTable(data.columns || [], data.rows || []);
          results.appendChild(table);
        } catch (e) {
          status.textContent = 'Request failed';
        }
      }
      document.getElementById('sql_run').addEventListener('click', runSQL);
      document.getElementById('alerts_filter').addEventListener('input', fetchStats);
      document.getElementById('alerts_only_smart').addEventListener('change', fetchStats);
      document.getElementById('alerts_only_high').addEventListener('change', fetchStats);

      // ---------- Logs ----------
      let logsTimer = null;
      async function fetchLogs(){
        const type = document.getElementById('logs_type').value;
        const limit = parseInt(document.getElementById('logs_limit').value||300,10);
        try{
          const r = await fetch(`/api/logs?type=${encodeURIComponent(type)}&limit=${limit}`);
          const data = await r.json();
          const pretty = (o)=>{ try{ return JSON.stringify(o, null, 2); }catch(e){ return String(o); } };
          const out = (data.rows||[]).map(pretty).join('\n\n');
          const pre = document.getElementById('logs_output');
          const atBottom = pre.scrollTop + pre.clientHeight >= pre.scrollHeight - 5;
          pre.textContent = out;
          if(atBottom) pre.scrollTop = pre.scrollHeight;
        }catch(e){/* ignore */}
      }
      function startLogsAuto(){
        if (logsTimer) clearInterval(logsTimer);
        if (document.getElementById('logs_autorefresh').checked){
          logsTimer = setInterval(fetchLogs, 3000);
        }
      }
      document.getElementById('logs_refresh').addEventListener('click', fetchLogs);
      document.getElementById('logs_autorefresh').addEventListener('change', startLogsAuto);
      // optional wrap/copy controls if present
      const wrapEl = document.getElementById('logs_wrap');
      if (wrapEl) wrapEl.addEventListener('change', ()=>{
        const pre = document.getElementById('logs_output');
        if (wrapEl.checked){ pre.style.whiteSpace='pre-wrap'; pre.style.wordBreak='break-word'; }
        else { pre.style.whiteSpace='pre'; pre.style.wordBreak='normal'; }
      });
      const copyEl = document.getElementById('logs_copy');
      if (copyEl) copyEl.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(document.getElementById('logs_output').textContent||''); }catch(e){}
      });
      fetchLogs(); startLogsAuto();

      // ---------- Tracked ----------
      async function fetchTracked(){
        try{
          const ac = new AbortController();
          const t = setTimeout(()=>ac.abort(), 4000);
          let r = await fetch('/api/tracked?limit=200', { signal: ac.signal });
          clearTimeout(t);
          if (!r.ok) throw new Error('tracked http '+r.status);
          let data = await r.json();
          // Fallback: if rows missing, try smaller payload once
          if (!Array.isArray(data.rows) || data.rows.length === 0){
            try{
              r = await fetch('/api/tracked?limit=50');
              if (r.ok) data = await r.json();
            }catch(e){/* ignore */}
          }
          const tbody = document.querySelector('#tracked_table tbody');
          tbody.innerHTML = '';
          const rows = Array.isArray(data.rows) ? data.rows : [];
          if (rows.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="10" class="muted">No tracked data yet</td>`;
            tbody.appendChild(tr);
            return;
          }
          rows.forEach(row=>{
            const tr = document.createElement('tr');
            const isFiniteNum = (v)=> (typeof v === 'number' && isFinite(v));
            const fmt = (v, d=8)=> (isFiniteNum(v) && v!==0 ? Number(v).toFixed(d) : '-')
            const fmtMoney = (v)=> (isFiniteNum(v) && v!==0 ? ('$'+Number(v).toLocaleString()) : '-')
            tr.innerHTML = `
              <td>${tokenLinks(row.token)}</td>
              <td>${row.alerted_at||'-'}</td>
              <td>${row.final_score??'-'}</td>
              <td>${row.conviction||'-'}</td>
              <td>${[fmt(row.first_price),fmt(row.last_price),fmt(row.peak_price)].join(' → ')}</td>
              <td>${row.peak_multiple!=null?('×'+Number(row.peak_multiple).toFixed(2)):'-'}</td>
              <td>${[fmtMoney(row.first_mcap),fmtMoney(row.last_mcap),fmtMoney(row.peak_mcap)].join(' → ')}</td>
              <td>${fmtMoney(row.last_liq)}</td>
              <td>${fmtMoney(row.last_vol24)}</td>
              <td>${row.outcome||'-'}${row.peak_drawdown_pct!=null?(' ('+Number(row.peak_drawdown_pct).toFixed(1)+'%)'):''}</td>
            `;
            tbody.appendChild(tr);
          })
        }catch(e){/* ignore */}
      }
      fetchTracked(); setInterval(fetchTracked, 15000);

      // ---------- v2 Overview ----------
      async function fetchOverviewV2(){
        try{
          const [qs, sm, fh, bs, ra] = await Promise.all([
            fetch('/api/v2/quick-stats').then(r=>r.json()),
            fetch('/api/v2/smart-money-status').then(r=>r.json()),
            fetch('/api/v2/feed-health').then(r=>r.json()),
            fetch('/api/v2/budget-status').then(r=>r.json()),
            fetch('/api/v2/recent-activity?limit=20').then(r=>r.json()),
          ]);
          // Quick stats
          document.getElementById('total_alerts').textContent = String(qs.total_alerts||0);
          document.getElementById('alerts_24h').textContent = String(qs.alerts_24h||0);
          document.getElementById('tracking_count').textContent = String(qs.tracking_count||0);
          // Smart money
          document.getElementById('sm_24h').textContent = `${sm.smart_alerts_24h||0}/${sm.total_alerts_24h||0}`;
          document.getElementById('sm_status').textContent = `Avg ${sm.avg_score??'-'}/10 • ${sm.percentage??0}% • latest ${sm.latest_minutes_ago!=null? sm.latest_minutes_ago+'m ago':'-'} • cycle ${sm.current_cycle||'-'}`;
          // Feed health
          document.getElementById('feed_status').textContent = fh.status||'-';
          document.getElementById('feed_cycle').textContent = `${fh.current_cycle||'-'} (${fh.feed_items||0} items)`;
          // Budget
          document.getElementById('budget_day').textContent = `${bs.daily_used||0}/${bs.daily_max||0} (${bs.daily_percent||0}%)`;
          document.getElementById('budget_reset').textContent = `resets in ~${bs.reset_hours||0}h ${bs.reset_minutes||0}m`;
          // Recent table (reuse existing alerts table)
          const tbody = document.querySelector('#alerts_table tbody');
          tbody.innerHTML = '';
          (ra.alerts||[]).forEach(a=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.timestamp||''}</td><td>${tokenLinks(a.token_full||a.token)}</td><td>${a.symbol||''}</td><td>${a.score??''}</td><td>${a.conviction||''}</td><td></td><td></td><td></td>`;
            tbody.appendChild(tr);
          });
        }catch(e){/* ignore */}
      }

      // ---------- v2 Performance ----------
      async function fetchPerformanceV2(){
        try{
          const [q, t, h] = await Promise.all([
            fetch('/api/v2/signal-quality').then(r=>r.json()),
            fetch('/api/v2/performance-trends?days=7').then(r=>r.json()),
            fetch('/api/v2/hourly-heatmap').then(r=>r.json()),
          ]);
          document.getElementById('perf_avg_score').textContent = String(q.avg_score||0);
          document.getElementById('perf_total').textContent = String(q.total_signals||0);
          const convT = document.querySelector('#conviction_table tbody'); convT.innerHTML='';
          Object.entries(q.conviction_breakdown||{}).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td>${v}</td>`; convT.appendChild(tr); });
          const scoreT = document.querySelector('#score_table tbody'); scoreT.innerHTML='';
          Object.entries(q.score_distribution||{}).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td>${v}</td>`; scoreT.appendChild(tr); });
          const trendsT = document.querySelector('#trends_table tbody'); trendsT.innerHTML='';
          (t.trends||[]).forEach(row=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${row.date}</td><td>${row.alerts}</td><td>${row.smart_percentage}%</td><td>${row.avg_score}</td>`; trendsT.appendChild(tr); });
          const heatT = document.querySelector('#heatmap_table tbody'); heatT.innerHTML='';
          (h.heatmap||[]).forEach(row=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${row.hour}</td><td>${row.count}</td>`; heatT.appendChild(tr); });
        }catch(e){/* ignore */}
      }

      // ---------- v2 System ----------
      async function fetchSystemV2(){
        try{
          const s = await fetch('/api/v2/system-health').then(r=>r.json());
          const cpu = (s.resources&&s.resources.cpu_percent!=null)? s.resources.cpu_percent+'%':'-';
          const mem = (s.resources&&s.resources.memory_percent!=null)? s.resources.memory_percent+'%':'-';
          const disk = (s.resources&&s.resources.disk_percent!=null)? s.resources.disk_percent+'%':'-';
          document.getElementById('sys_cpu').textContent = cpu;
          document.getElementById('sys_mem').textContent = mem;
          document.getElementById('sys_disk').textContent = disk;
          const ct = document.querySelector('#containers_table tbody'); ct.innerHTML='';
          Object.entries(s.containers||{}).forEach(([name,info])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td>${(info||{}).details||''}</td>`; ct.appendChild(tr); });
          const dbs = await fetch('/api/v2/database-status').then(r=>r.json());
          const dbT = document.querySelector('#db_table tbody'); dbT.innerHTML='';
          Object.entries(dbs.tables||{}).forEach(([name,count])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td>${count}</td>`; dbT.appendChild(tr); });
          const errs = await fetch('/api/v2/error-logs?limit=50&level=all').then(r=>r.json());
          const eT = document.querySelector('#errors_table tbody'); eT.innerHTML='';
          (errs.logs||[]).forEach(row=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${row.timestamp||''}</td><td>${row.level||''}</td><td>${row.type||''}</td><td>${row.component||''}</td>`; eT.appendChild(tr); });
        }catch(e){/* ignore */}
      }

      // ---------- v2 Config ----------
      async function fetchConfigV2(){
        try{
          const cfg = await fetch('/api/v2/current-config').then(r=>r.json());
          const t = document.querySelector('#cfg_table tbody'); t.innerHTML='';
          Object.entries(cfg||{}).forEach(([group,vals])=>{
            Object.entries(vals||{}).forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${group}</td><td>${k}</td><td>${v}</td>`; t.appendChild(tr); });
          });
          document.getElementById('cfg_signals').checked = !!((cfg.toggles&&cfg.toggles.signals_enabled) || false);
          document.getElementById('cfg_trading').checked = !!((cfg.toggles&&cfg.toggles.trading_enabled) || false);
        }catch(e){/* ignore */}
      }

      // ---------- v2 Paper ----------
      async function fetchPaperV2(){
        try{
          const r = await fetch('/api/v2/paper/portfolio');
          const d = await r.json();
          const p = (d||{}).portfolio;
          const wrap = document.getElementById('pt_portfolio');
          if(!p){ wrap.innerHTML = '<div class="muted">No active session</div>'; return; }
          const rows = [];
          rows.push(`<div class=\"cards\"><div class=\"card\"><div class=\"label\">Current Value</div><div class=\"value\">$${(p.current_value||0).toLocaleString()}</div></div><div class=\"card\"><div class=\"label\">PnL</div><div class=\"value\">$${(p.total_pnl||0).toLocaleString()} (${p.total_pnl_percent||0}%)</div></div><div class=\"card\"><div class=\"label\">Win Rate</div><div class=\"value\">${p.win_rate||0}%</div></div></div>`);
          wrap.innerHTML = rows.join('') + '<h4 style="margin-top:12px">Open Positions</h4>';
          const table = document.createElement('table');
          table.innerHTML = '<thead><tr><th>Token</th><th>Score</th><th>Conviction</th><th>PnL%</th><th>PnL$</th><th>Hold (h)</th></tr></thead><tbody></tbody>';
          const tb = table.querySelector('tbody');
          (p.open_positions||[]).forEach(pos=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${tokenLinks(pos.token)}</td><td>${pos.score}</td><td>${pos.conviction}</td><td>${(pos.pnl_percent||0).toFixed(1)}%</td><td>$${(pos.pnl_usd||0).toFixed(2)}</td><td>${(pos.hold_time_hours||0).toFixed(2)}</td>`; tb.appendChild(tr); });
          wrap.appendChild(table);
        }catch(e){/* ignore */}
      }

      document.getElementById('pt_start').addEventListener('click', async ()=>{
        const body = { capital: Number(document.getElementById('pt_capital').value||1000), strategy: document.getElementById('pt_strategy').value, position_sizing: document.getElementById('pt_sizing').value, max_concurrent: Number(document.getElementById('pt_max').value||5) };
        await fetch('/api/v2/paper/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        fetchPaperV2();
      });
      document.getElementById('pt_stop').addEventListener('click', async ()=>{ await fetch('/api/v2/paper/stop', { method:'POST' }); fetchPaperV2(); });
      document.getElementById('pt_reset').addEventListener('click', async ()=>{ await fetch('/api/v2/paper/reset', { method:'POST' }); fetchPaperV2(); });
      document.getElementById('bt_run').addEventListener('click', async ()=>{
        const body = { days: Number(document.getElementById('bt_days').value||7), capital: Number(document.getElementById('bt_capital').value||1000), strategy: document.getElementById('bt_strategy').value };
        const r = await fetch('/api/v2/paper/backtest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const d = await r.json();
        document.getElementById('bt_output').textContent = JSON.stringify(d, null, 2);
      });
    </script>
  </body>
  </html>


